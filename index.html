from flask import Flask, jsonify
import requests
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

DEX_CHAINS = {
    "Uniswap": "ethereum",
    "PancakeSwap": "bsc"
}

@app.route("/pools/<dex>")
def get_pools(dex):
    chain = DEX_CHAINS.get(dex)
    if not chain:
        return jsonify([])

    url = f"https://api.dexscreener.io/latest/dex/pairs/{chain}"
    r = requests.get(url, timeout=10)
    data = r.json().get("pairs", [])[:15]

    pools = []
    for p in data:
        liquidity = p.get("liquidity", {}).get("usd", 0)
        volume24 = p.get("volume", {}).get("h24", 0)
        price_change = p.get("priceChange", {}).get("h24", 0)
        spark = p.get("sparkline", [])

        tvl = float(liquidity)
        vol = float(volume24)

        fee_tvl = (vol / tvl * 100) if tvl else 0
        apr = fee_tvl * 365

        pools.append({
            "pair": p["baseToken"]["symbol"] + "/" + p["quoteToken"]["symbol"],
            "pairAddress": p["pairAddress"],
            "tvl": tvl,
            "volume24h": vol,
            "feeTvl": round(fee_tvl, 2),
            "apr": round(apr, 2),
            "volatility": round(price_change, 2),
            "sparkline": spark
        })

    return jsonify(pools)

app.run(port=5001)
